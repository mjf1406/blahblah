import{a as T,u as q,r as n,j as e,B as l,S as de,t as d}from"./index-DuR0837i.js";import{D as $,a as oe,b as Q,c as V,d as J,L as o,I as m}from"./label-C1vPNv8q.js";import{u as me,P as k,T as P,C as ue,a as he,b as xe,S as pe,A as je,c as fe,d as ve,e as ye,f as ge,g as Ne,h as we,i as be,j as Ce,B as U,k as Ee}from"./usePersistsedQuery-Bl2mrG3j.js";import{T as G,S as K,a as W,b as X,c as Y,d as h}from"./select-0A0iz8iE.js";import"./index-CcVNOCKz.js";function Ae(){const{data:E=[]}=me(T.encounters.list,"encounters-list"),Z=q(T.encounters.create),ee=q(T.encounters.update),se=q(T.encounters.remove),[te,S]=n.useState(!1),[ae,D]=n.useState(!1),[M,O]=n.useState(null),[j,f]=n.useState(""),[_,v]=n.useState(""),[y,g]=n.useState(""),[L,N]=n.useState(1),[x,p]=n.useState([]),[w,b]=n.useState([]),[H,F]=n.useState(new Set);n.useEffect(()=>{if(E.length>0&&w.length>0){const s=w.filter(a=>!E.some(t=>t.name===a.name&&t.description===a.description&&t.difficulty===a.difficulty));s.length!==w.length&&b(s)}},[E.length,JSON.stringify(w)]);const I=n.useMemo(()=>[...E.filter(a=>!H.has(a._id)).map(a=>({...a,isOptimistic:!1})),...w].sort((a,t)=>t._creationTime-a._creationTime),[E,w,H]),z=()=>{f(""),v(""),g(""),N(1),p([])},B=()=>{p([...x,{name:"",quantity:1,cr:"1/4"}])},R=s=>{p(x.filter((a,t)=>t!==s))},C=(s,a,t)=>{const i=[...x];i[s]={...i[s],[a]:t},p(i)},ie=async s=>{if(s.preventDefault(),!j.trim()){d.error("Encounter name is required");return}if(!y){d.error("Difficulty is required");return}const a=x.filter(u=>u.name.trim()),t={name:j.trim(),description:_.trim(),difficulty:y,partyLevel:L,monsters:a},i={_id:`temp-${Date.now()}`,name:t.name,description:t.description,difficulty:t.difficulty,partyLevel:t.partyLevel,monsters:t.monsters,_creationTime:Date.now(),isOptimistic:!0};b(u=>[i,...u]),z(),S(!1),d.success("Encounter created successfully!");try{await Z(t)}catch{b(r=>r.filter(c=>c._id!==i._id)),d.error("Failed to create encounter"),f(t.name),v(t.description),g(t.difficulty),N(t.partyLevel),p(t.monsters),S(!0)}},re=async s=>{if(s.preventDefault(),!M)return;if(!j.trim()){d.error("Encounter name is required");return}if(!y){d.error("Difficulty is required");return}const a=x.filter(r=>r.name.trim()),t={name:j.trim(),description:_.trim(),difficulty:y,partyLevel:L,monsters:a},i=M,u={_id:`temp-edit-${M._id}-${Date.now()}`,name:t.name,description:t.description,difficulty:t.difficulty,partyLevel:t.partyLevel,monsters:t.monsters,_creationTime:M._creationTime,isOptimistic:!0};F(r=>new Set(r).add(i._id)),b(r=>[u,...r]),z(),O(null),D(!1),d.success("Encounter updated successfully!");try{await ee({id:i._id,name:t.name,description:t.description,difficulty:t.difficulty,partyLevel:t.partyLevel,monsters:t.monsters}),b(r=>r.filter(c=>c._id!==u._id)),F(r=>{const c=new Set(r);return c.delete(i._id),c})}catch{b(c=>c.filter(A=>A._id!==u._id)),F(c=>{const A=new Set(c);return A.delete(i._id),A}),d.error("Failed to update encounter"),O(i),f(t.name),v(t.description),g(t.difficulty),N(t.partyLevel),p(t.monsters),D(!0)}},ne=s=>{O(s),f(s.name),v(s.description),g(s.difficulty),N(s.partyLevel),p(s.monsters),D(!0)},le=async s=>{try{await se({id:s}),d.success("Encounter deleted successfully!")}catch{d.error("Failed to delete encounter")}},ce=s=>{switch(s){case"Easy":return"bg-green-100 text-green-800";case"Medium":return"bg-yellow-100 text-yellow-800";case"Hard":return"bg-orange-100 text-orange-800";case"Deadly":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Encounters"}),e.jsxs($,{open:te,onOpenChange:S,children:[e.jsx(oe,{asChild:!0,children:e.jsxs(l,{children:[e.jsx(k,{className:"w-4 h-4 mr-2"}),"Add Encounter"]})}),e.jsxs(Q,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(V,{children:e.jsx(J,{children:"Create New Encounter"})}),e.jsxs("form",{onSubmit:s=>void ie(s),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"name",children:"Encounter Name"}),e.jsx(m,{id:"name",value:j,onChange:s=>f(s.target.value),placeholder:"Enter encounter name"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"description",children:"Description"}),e.jsx(G,{id:"description",value:_,onChange:s=>v(s.target.value),placeholder:"Describe the encounter...",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"difficulty",children:"Difficulty"}),e.jsxs(K,{value:y,onValueChange:g,children:[e.jsx(W,{children:e.jsx(X,{placeholder:"Select difficulty"})}),e.jsxs(Y,{children:[e.jsx(h,{value:"Easy",children:"Easy"}),e.jsx(h,{value:"Medium",children:"Medium"}),e.jsx(h,{value:"Hard",children:"Hard"}),e.jsx(h,{value:"Deadly",children:"Deadly"})]})]})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"partyLevel",children:"Party Level"}),e.jsx(m,{id:"partyLevel",type:"number",min:"1",max:"20",value:L,onChange:s=>N(parseInt(s.target.value)||1)})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(o,{children:"Monsters"}),e.jsxs(l,{type:"button",variant:"outline",size:"sm",onClick:B,children:[e.jsx(k,{className:"w-4 h-4 mr-1"}),"Add Monster"]})]}),e.jsx("div",{className:"space-y-2 overflow-y-auto max-h-48",children:x.map((s,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx(m,{placeholder:"Monster name",value:s.name,onChange:t=>C(a,"name",t.target.value)})}),e.jsx("div",{className:"w-20",children:e.jsx(m,{type:"number",min:"1",placeholder:"Qty",value:s.quantity,onChange:t=>C(a,"quantity",parseInt(t.target.value)||1)})}),e.jsx("div",{className:"w-20",children:e.jsx(m,{placeholder:"CR",value:s.cr,onChange:t=>C(a,"cr",t.target.value)})}),e.jsx(l,{type:"button",variant:"outline",size:"sm",onClick:()=>R(a),children:e.jsx(P,{className:"w-4 h-4"})})]},a))})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(l,{type:"button",variant:"outline",onClick:()=>S(!1),className:"flex-1",children:"Cancel"}),e.jsx(l,{type:"submit",className:"flex-1",children:"Create Encounter"})]})]})]})]}),e.jsx($,{open:ae,onOpenChange:D,children:e.jsxs(Q,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx(V,{children:e.jsx(J,{children:"Edit Encounter"})}),e.jsxs("form",{onSubmit:s=>void re(s),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"editName",children:"Encounter Name"}),e.jsx(m,{id:"editName",value:j,onChange:s=>f(s.target.value),placeholder:"Enter encounter name"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"editDescription",children:"Description"}),e.jsx(G,{id:"editDescription",value:_,onChange:s=>v(s.target.value),placeholder:"Describe the encounter...",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"editDifficulty",children:"Difficulty"}),e.jsxs(K,{value:y,onValueChange:g,children:[e.jsx(W,{children:e.jsx(X,{placeholder:"Select difficulty"})}),e.jsxs(Y,{children:[e.jsx(h,{value:"Easy",children:"Easy"}),e.jsx(h,{value:"Medium",children:"Medium"}),e.jsx(h,{value:"Hard",children:"Hard"}),e.jsx(h,{value:"Deadly",children:"Deadly"})]})]})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"editPartyLevel",children:"Party Level"}),e.jsx(m,{id:"editPartyLevel",type:"number",min:"1",max:"20",value:L,onChange:s=>N(parseInt(s.target.value)||1)})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(o,{children:"Monsters"}),e.jsxs(l,{type:"button",variant:"outline",size:"sm",onClick:B,children:[e.jsx(k,{className:"w-4 h-4 mr-1"}),"Add Monster"]})]}),e.jsx("div",{className:"space-y-2 overflow-y-auto max-h-48",children:x.map((s,a)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[e.jsx("div",{className:"flex-1",children:e.jsx(m,{placeholder:"Monster name",value:s.name,onChange:t=>C(a,"name",t.target.value)})}),e.jsx("div",{className:"w-20",children:e.jsx(m,{type:"number",min:"1",placeholder:"Qty",value:s.quantity,onChange:t=>C(a,"quantity",parseInt(t.target.value)||1)})}),e.jsx("div",{className:"w-20",children:e.jsx(m,{placeholder:"CR",value:s.cr,onChange:t=>C(a,"cr",t.target.value)})}),e.jsx(l,{type:"button",variant:"outline",size:"sm",onClick:()=>R(a),children:e.jsx(P,{className:"w-4 h-4"})})]},a))})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(l,{type:"button",variant:"outline",onClick:()=>D(!1),className:"flex-1",children:"Cancel"}),e.jsx(l,{type:"submit",className:"flex-1",children:"Update Encounter"})]})]})]})})]}),I.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx(de,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-lg text-gray-500",children:"No encounters created yet"}),e.jsx("p",{className:"text-gray-400",children:'Click "Add Encounter" to get started'})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:I.map(s=>e.jsxs(ue,{className:`hover:shadow-md transition-shadow ${s.isOptimistic?"opacity-70 animate-pulse":""}`,children:[e.jsxs(he,{className:"relative",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs(xe,{className:"flex items-center gap-2 pr-8 text-lg",children:[s.name,s.isOptimistic&&e.jsx("span",{className:"px-2 py-1 text-xs rounded text-muted-foreground bg-muted",children:"Saving..."})]}),!s.isOptimistic&&e.jsxs("div",{className:"absolute flex gap-1 top-4 right-4",children:[e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>ne(s),className:"w-8 h-8 p-0 hover:bg-gray-100",children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsxs(je,{children:[e.jsx(fe,{asChild:!0,children:e.jsx(l,{variant:"ghost",size:"sm",className:"w-8 h-8 p-0 hover:bg-red-100 hover:text-red-600",children:e.jsx(P,{className:"w-4 h-4"})})}),e.jsxs(ve,{children:[e.jsxs(ye,{children:[e.jsx(ge,{children:"Delete Encounter"}),e.jsxs(Ne,{children:['Are you sure you want to delete "',s.name,'"? This action cannot be undone.']})]}),e.jsxs(we,{children:[e.jsx(be,{children:"Cancel"}),e.jsx(Ce,{onClick:()=>void le(s._id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:ce(s.difficulty),children:s.difficulty}),e.jsxs(U,{variant:"outline",children:["Level ",s.partyLevel]})]})]}),e.jsx(Ee,{children:e.jsxs("div",{className:"space-y-3",children:[s.description&&e.jsx("p",{className:"text-sm text-gray-600",children:s.description}),s.monsters.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"mb-1 text-sm font-medium text-gray-600",children:"Monsters:"}),e.jsx("div",{className:"space-y-1",children:s.monsters.map((a,t)=>e.jsxs("div",{className:"flex justify-between text-xs text-gray-500",children:[e.jsx("span",{children:a.name}),e.jsxs("span",{children:["×",a.quantity," ","(CR ",a.cr,")"]})]},t))})]})]})})]},s._id))})]})}export{Ae as EncounterManager};
