import{a as b,u as A,r as o,j as e,B as g,t as m}from"./index-bjD2Wxva.js";import{D as B,a as V,b as I,c as J,d as M,L as w,I as T}from"./label-BfUWol79.js";import{u as W,P as H,C as X,a as Z,b as ee,S as te,A as se,c as ae,T as Q,d as ie,e as re,f as le,g as ne,h as ce,i as de,j as oe,k as me,B as xe}from"./usePersistsedQuery-Bw8aV3mj.js";function $({partyName:u,setPartyName:C,levels:P,onSubmit:S,onCancel:D,submitText:y,addLevel:_,removeLevel:p,updateLevel:N}){return e.jsxs("form",{onSubmit:n=>void S(n),className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(w,{htmlFor:"partyName",children:"Party Name"}),e.jsx(T,{id:"partyName",value:u,onChange:n=>C(n.target.value),placeholder:"Enter party name",className:"mt-1"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(w,{children:"Character Levels"}),e.jsxs(g,{type:"button",variant:"outline",size:"sm",onClick:_,children:[e.jsx(H,{className:"w-4 h-4 mr-1"}),"Add Level"]})]}),e.jsx("div",{className:"space-y-2 overflow-y-auto max-h-48",children:P.map((n,l)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 border rounded",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(w,{className:"text-xs",children:"Level"}),e.jsx(T,{type:"number",min:"1",max:"20",value:n.level,onChange:c=>N(l,"level",parseInt(c.target.value)||1),className:"mt-1"})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx(w,{className:"text-xs",children:"Quantity"}),e.jsx(T,{type:"number",min:"1",value:n.quantity,onChange:c=>N(l,"quantity",parseInt(c.target.value)||1),className:"mt-1"})]}),e.jsx(g,{type:"button",variant:"outline",size:"sm",onClick:()=>p(l),className:"mt-5",children:e.jsx(Q,{className:"w-4 h-4"})})]},l))}),P.length===0&&e.jsx("p",{className:"py-4 text-sm text-center text-gray-500",children:"No character levels added yet"})]}),e.jsxs("div",{className:"flex gap-2 pt-4",children:[e.jsx(g,{type:"button",variant:"outline",onClick:D,className:"flex-1",children:"Cancel"}),e.jsx(g,{type:"submit",className:"flex-1",children:y})]})]})}function ve(){const{data:u=[]}=W(b.parties.list,"parties-list"),C=A(b.parties.create),P=A(b.parties.update),S=A(b.parties.remove),[D,y]=o.useState(!1),[_,p]=o.useState(!1),[N,n]=o.useState(null),[l,c]=o.useState(""),[x,v]=o.useState([]),[j,f]=o.useState([]),[L,O]=o.useState(new Set),R=o.useMemo(()=>JSON.stringify(j),[j]);o.useEffect(()=>{if(u.length>0&&j.length>0){const t=j.filter(a=>!u.some(s=>s.name===a.name&&JSON.stringify(s.levels)===JSON.stringify(a.levels)));t.length!==j.length&&f(t)}},[u,R]);const q=o.useMemo(()=>[...u.filter(a=>!L.has(a._id)).map(a=>({...a,isOptimistic:!1})),...j].sort((a,s)=>s._creationTime-a._creationTime),[u,j,L]),E=()=>{v([...x,{level:1,quantity:1}])},k=t=>{v(x.filter((a,s)=>s!==t))},F=(t,a,s)=>{const r=[...x];r[t][a]=s,v(r)},z=()=>{c(""),v([])},U=async t=>{if(t.preventDefault(),!l.trim()){m.error("Party name is required");return}if(x.length===0){m.error("At least one character level is required");return}const a=x.filter(d=>d.level>0&&d.quantity>0),s={name:l.trim(),levels:a},r={_id:`temp-${Date.now()}`,name:s.name,levels:s.levels,_creationTime:Date.now(),isOptimistic:!0};f(d=>[r,...d]),z(),y(!1),m.success("Party created successfully!");try{await C(s)}catch{f(d=>d.filter(i=>i._id!==r._id)),m.error("Failed to create party"),c(s.name),v(s.levels),y(!0)}},Y=async t=>{if(t.preventDefault(),!N)return;if(!l.trim()){m.error("Party name is required");return}if(x.length===0){m.error("At least one character level is required");return}const a=x.filter(i=>i.level>0&&i.quantity>0),s={name:l.trim(),levels:a},r=N,d={_id:`temp-edit-${r._id}-${Date.now()}`,name:s.name,levels:s.levels,_creationTime:r._creationTime,isOptimistic:!0};O(i=>new Set(i).add(r._id)),f(i=>[d,...i]),z(),n(null),p(!1),m.success("Party updated successfully!");try{await P({id:r._id,name:s.name,levels:s.levels}),f(i=>i.filter(h=>h._id!==d._id)),O(i=>{const h=new Set(i);return h.delete(r._id),h})}catch{f(i=>i.filter(h=>h._id!==d._id)),O(i=>{const h=new Set(i);return h.delete(r._id),h}),m.error("Failed to update party"),n(r),c(s.name),v(s.levels),p(!0)}},G=t=>{n(t),c(t.name),v(t.levels),p(!0)},K=async t=>{try{await S({id:t}),m.success("Party deleted successfully!")}catch{m.error("Failed to delete party")}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Your Parties"}),e.jsxs(B,{open:D,onOpenChange:y,children:[e.jsx(V,{asChild:!0,children:e.jsxs(g,{children:[e.jsx(H,{className:"w-4 h-4 mr-2"}),"Add Party"]})}),e.jsxs(I,{className:"sm:max-w-md",children:[e.jsx(J,{children:e.jsx(M,{children:"Create New Party"})}),e.jsx($,{partyName:l,setPartyName:c,levels:x,onSubmit:U,onCancel:()=>y(!1),submitText:"Create Party",addLevel:E,removeLevel:k,updateLevel:F})]})]}),e.jsx(B,{open:_,onOpenChange:p,children:e.jsxs(I,{className:"sm:max-w-md",children:[e.jsx(J,{children:e.jsx(M,{children:"Edit Party"})}),e.jsx($,{partyName:l,setPartyName:c,levels:x,onSubmit:Y,onCancel:()=>p(!1),submitText:"Update Party",addLevel:E,removeLevel:k,updateLevel:F})]})})]}),q.length===0?e.jsxs("div",{className:"py-12 text-center",children:[e.jsx("p",{className:"text-lg text-gray-500",children:"No parties created yet"}),e.jsx("p",{className:"text-gray-400",children:'Click "Add Party" to get started'})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:q.map(t=>e.jsxs(X,{className:`hover:shadow-md transition-shadow ${t.isOptimistic?"opacity-70 animate-pulse":""}`,children:[e.jsx(Z,{className:"relative",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs(ee,{className:"flex items-center gap-2 pr-8 text-lg",children:[t.name,t.isOptimistic&&e.jsx("span",{className:"px-2 py-1 text-xs rounded text-muted-foreground bg-muted",children:"Saving..."})]}),!t.isOptimistic&&e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>G(t),className:"absolute w-8 h-8 p-0 top-4 right-12 hover:bg-gray-100",children:e.jsx(te,{className:"w-4 h-4"})}),!t.isOptimistic&&e.jsxs(se,{children:[e.jsx(ae,{asChild:!0,children:e.jsx(g,{variant:"ghost",size:"sm",className:"absolute w-8 h-8 p-0 top-4 right-4 hover:bg-red-100 hover:text-red-600",children:e.jsx(Q,{className:"w-4 h-4"})})}),e.jsxs(ie,{children:[e.jsxs(re,{children:[e.jsx(le,{children:"Delete Party"}),e.jsxs(ne,{children:['Are you sure you want to delete "',t.name,'"? This action cannot be undone.']})]}),e.jsxs(ce,{children:[e.jsx(de,{children:"Cancel"}),e.jsx(oe,{onClick:()=>void K(t._id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})}),e.jsx(me,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Character Levels:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:t.levels.sort((a,s)=>a.level-s.level).map((a,s)=>e.jsxs(xe,{variant:"secondary",className:"text-xs",children:["Level ",a.level," Ã—"," ",a.quantity]},s))}),e.jsxs("div",{className:"pt-2 text-xs text-gray-500",children:["Total Characters:"," ",t.levels.reduce((a,s)=>a+s.quantity,0)]})]})})]},t._id))})]})}export{ve as PartyManager};
